<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="asset/icon/favicon.ico">
    <link rel="icon" sizes="16x16" href="asset/icon/favicon-16x16.png">
    <link rel="icon" sizes="32x32" href="asset/icon/favicon-32x32.png">
    <link rel="icon" sizes="180x180" href="asset/icon/favicon-180x180.png">
    <link rel="icon" sizes="192x192" href="asset/icon/favicon-192x192.png">
    <link rel="icon" sizes="512x512" href="asset/icon/favicon-192x192.png">
    <link rel="stylesheet/less" type="text/css" href="styles.less" />
    <title>Uonihon</title>
    <script src="https://cdn.jsdelivr.net/npm/less"></script>
</head>

<body onload="initUonihon()">

    <script>

        const HOST = "http://192.168.1.86:8080"

        let words = ""
        let sentences = ""
        let usage = ""
        let noKanjiMode = false
        let currentWord = undefined

        document.addEventListener('visibilitychange', (event) => {
            if (currentWord?.id) {
                saveCurrentWord()
            }
        });

        function initUonihon() {
            fetch(HOST + "/word/words/all", {
                method: "GET", headers: { "Content-type": "application/json; charset=UTF-8" }
            }).then((response) => response.text()).then((response) => {
                words = response;
            });
            getWord(null, 'reading')
        }

        function saveCurrentWord() {
            return fetch(HOST + "/word/save", {
                method: "POST", keepalive: true, 
                headers: { "Content-type": "application/json; charset=UTF-8" },
                body: JSON.stringify(currentWord)
            });
        }

        async function getWord(wordId, focus) {

            if (currentWord) {
                await saveCurrentWord()
            }

            const finalUrl = HOST 
                + "/word" 
                + (wordId ? `/${wordId}` : "") 
                + (focus ? ("?" + new URLSearchParams({focus: focus}).toString()) : "")

            fetch(finalUrl, {
                method: "GET",
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                }
            })
                .then((response) => response.json())
                .then((json) => {
                    resetObfuscation();
                    if (focus=="reading") {
                        obfuscation('word');
                        obfuscation('reading');
                        obfuscation('explainer');
                    } else if (focus=="writing") {
                        obfuscation('meaning');
                        obfuscation('reading');
                        obfuscation('alternative');
                        obfuscation('explainer');
                    }
                    obf = v => ((v=='jp' && focus=="reading") || (v=='tr' && focus=="writing")) ? 'obfuscated' : ''

                    currentWord = {...json, unlocked: "1"}
                    document.getElementById('word').innerText = json.word ?? "";
                    document.getElementById('reading').innerText = json.reading ?? "";
                    document.getElementById('meaning').innerText = json.meaning ?? "";
                    document.getElementById('alternative').innerText = json.alternative ?? "";
                    document.getElementById('explainer').innerText = (json.explainer?.replace(/\\n/g, "\n")) ?? "";
                    document.getElementById('familiarity-choice-value').innerText = json.familiarity ?? "";
                    document.getElementById('amount-seen-value').innerText = json.testAmount ?? "";
                    document.getElementById('date-last-seen-value').innerText = json.lastTestDate ?? "";
                    switchNoKanjiMode(currentWord.useReading)

                    var sentences = document.getElementById('sentences-container');
                    sentences.replaceChildren();
                    (json.sentences ?? [])?.forEach(function (sentence, i) {
                        let htmlSentence = `
              <div class="line"> </div>
              <div class="card one" onclick="obfuscation('sentence${i + 1}')">
                <div class="label">Phrase ${i + 1}</div>
                <div id="sentence${i + 1}" class="card-inner ${obf('jp')} long">${sentence.japanese}</div>
              </div>
              <div class="card one" onclick="obfuscation('translation${i + 1}')">
                <div class="label">Traduction ${i + 1}</div>
                <div id="translation${i + 1}" class="card-inner ${obf('tr')} long">${sentence.translation}</div>
              </div>
            `
                        sentences.insertAdjacentHTML('beforeend', htmlSentence)
                    });
                });
        }

        function doSomething(toWrite) {
            fetch(HOST + "kanjis", {
                method: "POST",
                body: JSON.stringify({
                    message: toWrite
                }),
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
                .then((response) => response.json())
                .then((json) => console.log(json));
        }

        function setVisibleMainTab(tab) {
            var kanaTabNode = document.querySelector('.kanaTab');
            var kanjiTabNode = document.querySelector('.kanjiTab');
            var vocabularyTabNode = document.querySelector('.vocabularyTab');
            var toSetVisibleNode = document.querySelector('.' + tab);
            kanaTabNode.style.visibility = 'collapse';
            kanjiTabNode.style.visibility = 'collapse';
            vocabularyTabNode.style.visibility = 'collapse';
            toSetVisibleNode.style.visibility = 'visible';
            color = ""
            switch (tab) {
                case 'kanjiTab':
                    color = "lighten(@secondary,10%)"
                    break;
                case 'kanaTab':
                    color = "lighten(@tertiary,10%)"
                    break;
                default:
                    color = "lighten(@primary,10%)"
            }
            less.modifyVars({
                '@current-tab-color': color,
            });
        }

        function switchWordListVisibility() {
            var listNode = document.querySelector('.word-list-container');
            var testNode = document.querySelector('.word-test-container');
            var listTableNode = document.querySelector('#word-list-table');
            if (listNode.style.visibility == 'collapse') {
                listNode.style.visibility = 'visible'
                testNode.style.visibility = 'collapse';
                listTableNode.replaceChildren();
                words.split('\n').forEach(function (wordLine, i) {
                    if (wordLine == "") return
                    let splittedLine = wordLine.split('|')
                    let htmlSentence = `
                    <tr id="wordListIdx${i + 1}" onclick="(() => {getWord('${splittedLine[0].trim()}'); switchWordListVisibility(); })()">
                        <td>${splittedLine[1]}</td>
                        <td>${splittedLine[2]}</td>
                        <td>${splittedLine[3]}</td>
                        <td>${splittedLine[4]}</td>
                    </tr>`
                    listTableNode.insertAdjacentHTML('beforeend', htmlSentence)
                });
            } else {
                listNode.style.visibility = 'collapse';
                testNode.style.visibility = 'visible';
            }
        }

        function resetObfuscation() {
            let elements = document.getElementsByClassName("card-inner")
            Array.from(elements).forEach(e => {
                if (e.classList.contains("obfuscated")) {
                    e.classList.remove("obfuscated");
                }
            })
        }

        function obfuscation(id) {
            let element = document.getElementById(id)
            if (element.classList.contains("obfuscated")) {
                element.classList.remove("obfuscated");
            } else {
                element.classList.add("obfuscated");
            }
        }
        function switchNoKanjiMode(value) {
            currentWord.useReading = value??(currentWord.useReading=="0" ? "1" : "0")
            const isNoKanji = currentWord.useReading == "0" ? false : true
            document.getElementById("no-kanji-checkbox").checked = isNoKanji
            document.getElementById('word').innerText = isNoKanji ? currentWord.reading : currentWord.word
            document.getElementById("no-kanji-label").style.visibility = isNoKanji ? 'visible' : 'collapse'
        }

    </script>

    <div class="app-container">
        <div class="main-view-containers">
            <div class="main-view-container vocabularyTab">

                <div class="word-list-container" style="visibility: collapse;">
                    <table class="elegant-table"><thead>
                        <tr>
                          <th>Mot</th>
                          <th>Prononciation</th>
                          <th>Sens</th>
                          <th>Autres Sens</th>
                        </tr></thead>
                      <tbody id="word-list-table">
                      </tbody>
                      </table>
                </div>

                <div class="word-test-container">
                    <div class="card-container">

                        <div class="card two" onclick="obfuscation('word')">
                            <div class="label">Mot <span id="no-kanji-label">(Sans Kanji)</span></div>
                            <div id='word' class="card-inner short">
                            </div>
                        </div>

                        <div class="card two" onclick="obfuscation('reading')">
                            <div class="label">Prononciation</div>
                            <div id="reading" class="card-inner short"></div>
                        </div>

                    </div>

                    <div class="line"> </div>

                    <div class="card-container">

                        <div class="card two" onclick="obfuscation('meaning')">
                            <div class="label">Sens Principal</div>
                            <div id="meaning" class="card-inner long"></div>
                        </div>

                        <div class="card two" onclick="obfuscation('alternative')">
                            <div class="label">Autres Sens</div>
                            <div id="alternative" class="card-inner long">
                            </div>
                        </div>

                    </div>

                    <div class="line"> </div>

                    <div class="card one" onclick="obfuscation('explainer')">
                        <div class="label">Explications</div>
                        <div id="explainer" class="card-inner long"></div>
                    </div>

                    <div id="sentences-container">
                    </div>
                </div>

                <div class="line"> </div>

                <div class="footer">

                    <div class="card-container">
                        <div id="no-kanji-choice" class="card-inner two long setting" onclick="switchNoKanjiMode()">
                            <input type="checkbox" autocomplete="off" id="no-kanji-checkbox" class="checkbox-style" onclick="switchNoKanjiMode()">
                            <label for="no-kanji-checkbox">Mode Sans-Kanji</label>
                        </div>
                        <div id="familiarity-choice" class="card-inner two long setting">
                            Familiarité :&nbsp
                            <span id="familiarity-choice-value">1542</span>
                        </div>
                    </div>

                    <div class="sub-footer">
                        <span id="amount-seen-info">Nombre de fois vus : <span id="amount-seen-value">1542</span></span>
                        <span id="date-last-seen">Date du dernier test : <span id="date-last-seen-value">02/45/2024 08h56</span></span>
                    </div>

                </div>

                <div class="line"> </div>

                <div class="footer">
                    <div class="card-container">
                        <div id="no-kanji-choice" class="card-inner two long setting" onclick="switchNoKanjiMode()">
                            <input type="checkbox" autocomplete="off" id="no-kanji-checkbox" class="checkbox-style" onclick="switchNoKanjiMode()">
                            <label for="no-kanji-checkbox">Verrouiller</label>
                        </div>
                        <div id="familiarity-choice" class="card-inner two long setting">
                            Supprimer
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-view-container kanjiTab" style="visibility: collapse;">
                this is the kanji tab Start
                <div class="wideguy secondary-background"></div>
                this is the kanji tab End
            </div>
            <div class="main-view-container kanaTab" style="visibility: collapse;">
                this is the kana tab Start
                <div class="wideguy tertiary-background"></div>
                this is the kana tab End
            </div>
        </div>

        <!-- SUB FOOTER TABS -->
        <div class="tabs-container sub-sub-tabs-container">
            <div class="tab three-tabs" onclick="switchWordListVisibility()">
                <img class="tab-icon" src="asset/list.png" alt="Vocabulary icon">
                <span class="tab-text">List</span>
            </div>
            <div class="tab three-tabs" onclick="getWord()">
                <img class="tab-icon" src="asset/next.png" alt="Vocabulary icon">
                <span class="tab-text">Next</span>
            </div>
            <div class="tab three-tabs" onclick="setVisibleTab('consumeTab')">
                <img class="tab-icon" src="asset/search.png" alt="Kanji icon">
                <span class="tab-text">Search</span>
            </div>
        </div>

        <!-- SUB FOOTER TABS -->
        <div class="tabs-container sub-tabs-container">
            <div class="tab three-tabs" onclick="getWord(null, 'reading')">
                <img class="tab-icon" src="asset/arrow-down.png" alt="Vocabulary icon">
                <span class="tab-text">Read and Listen</span>
            </div>
            <div class="tab three-tabs" onclick="setVisibleTab('produceTab')">
                <img class="tab-icon" src="asset/cross.png" alt="Vocabulary icon">
                <span class="tab-text">Add</span>
            </div>
            <div class="tab three-tabs" onclick="getWord(null, 'writing')">
                <img class="tab-icon" src="asset/arrow-up.png" alt="Kanji icon">
                <span class="tab-text">Write and Speak</span>
            </div>
        </div>

        <!-- MAIN FOOTER TABS -->
        <div class="tabs-container main-tabs-container">
            <div class="tab three-tabs vocabularyTab" onclick="setVisibleMainTab('vocabularyTab')">
                <img class="tab-icon" src="asset/letterW.png" alt="Vocabulary icon">
                <span class="tab-text">Vocabulary</span>
            </div>
            <div class="tab three-tabs kanjiTab" onclick="setVisibleMainTab('kanjiTab')">
                <img class="tab-icon" src="asset/complicatedKanji.png" alt="Kanji icon">
                <span class="tab-text">Kanji</span>
            </div>
            <div class="tab three-tabs kanaTab" onclick="setVisibleMainTab('kanaTab')">
                <img class="tab-icon" src="asset/HiraganaKa.png" alt="Kana icon">
                <span class="tab-text">Kana</span>
            </div>
        </div>

    </div>

</body>

</html>