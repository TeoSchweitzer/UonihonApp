<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="asset/icon/favicon.ico">
    <link rel="icon" sizes="16x16" href="asset/icon/favicon-16x16.png">
    <link rel="icon" sizes="32x32" href="asset/icon/favicon-32x32.png">
    <link rel="icon" sizes="180x180" href="asset/icon/favicon-180x180.png">
    <link rel="icon" sizes="192x192" href="asset/icon/favicon-192x192.png">
    <link rel="icon" sizes="512x512" href="asset/icon/favicon-192x192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    <link rel="stylesheet/less" type="text/css" href="styles.less" />
    <title>Uonihon</title>
    <script src="https://cdn.jsdelivr.net/npm/less"></script>
</head>

<body onload="getWord()">

    <script>

        const HOST = "http://" + window.location.host

        let words = ""
        let filtered = ""
        let sentences = ""
        let usage = ""
        let noKanjiMode = false
        let currentWord = undefined
        let currentFocus = undefined

        function getAllWords() {
            return fetch(HOST + "/word/words/all", {
                method: "GET", headers: { "Content-type": "application/json; charset=UTF-8" }
            }).then((response) => response.text()).then((response) => {
                words = response;
                filtered = words;
            });
        }

        document.addEventListener('visibilitychange', (event) => {
            if (currentWord?.id) {
                saveCurrentWord()
            }
        });

        function saveCurrentWord() {
            if (currentFocus != undefined) {
                currentWord.familiarity = (parseInt(currentWord.familiarity)+1) + ""
                currentWord.testAmount = (parseInt(currentWord.testAmount)+1) + ""
            }
            return fetch(HOST + "/word/save" + (currentFocus ? ("?" + new URLSearchParams({focus: currentFocus}).toString()) : ""), {
                method: "POST", keepalive: true, 
                headers: { "Content-type": "application/json; charset=UTF-8" },
                body: JSON.stringify(currentWord)
            });
        }

        async function getWord(wordId, focus) {

            if (currentWord) {
                await saveCurrentWord()
            }

            currentFocus = focus

            const finalUrl = HOST 
                + "/word" 
                + (wordId ? `/${wordId}` : "") 
                + (currentFocus ? ("?" + new URLSearchParams({focus: focus}).toString()) : "")

            return fetch(finalUrl, {
                method: "GET",
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                }
            })
                .then((response) => response.json())
                .then((json) => {
                    resetObfuscation();
                    toHide = []
                    if (currentFocus=="writing") {
                        toHide = ['word','reading','explainer']
                    } else if (currentFocus=="reading") {
                        toHide = ['meaning','reading','alternative','explainer']
                    }
                    toHide.forEach(id => document.getElementById(id).classList.add("obfuscated"))
                    obf = v => ((v=='jp' && currentFocus=="writing") || (v=='tr' && currentFocus=="reading")) ? 'obfuscated' : ''

                    currentWord = {...json}

                    document.getElementById('word').innerText = json.word ?? "";
                    document.getElementById('reading').innerText = json.reading ?? "";
                    document.getElementById('meaning').innerText = json.meaning ?? "";
                    document.getElementById('alternative').innerText = json.alternative ?? "";
                    document.getElementById('explainer').innerText = (json.explainer?.replace(/\\n/g, "\n")) ?? "";
                    document.getElementById('familiarity-choice-value').innerText = json.familiarity ?? "";
                    document.getElementById('amount-seen-value').innerText = json.testAmount ?? "";
                    document.getElementById('date-last-seen-value').innerText = json.lastTestDate ?? "";
                    switchNoKanjiMode(currentWord.useReading)
                    switchUnlockedMode(currentWord.unlocked)

                    var sentences = document.getElementById('sentences-container');
                    sentences.replaceChildren();
                    (json.sentences ?? [])?.forEach(function (sentence, i) {
                        let htmlSentence = `
              <div class="line"> </div>
              <div class="obfuscation-container" style="margin: 12px 0" onclick="obfuscateOrEdit(event, 'sentence${i + 1}')">
                <div class="label">Phrase ${i + 1}</div>
                <div id="sentence${i + 1}" class="card ${obf('jp')} long">${sentence.japanese}</div>
              </div>
              <div class="obfuscation-container" onclick="obfuscateOrEdit(event, 'translation${i + 1}')">
                <div class="label">Traduction ${i + 1}</div>
                <div id="translation${i + 1}" class="card ${obf('tr')} long">${sentence.translation}</div>
              </div>
            `
                        sentences.insertAdjacentHTML('beforeend', htmlSentence)
                    });
                });
        }

        function obfuscateOrEdit(event, id) {
            simpleOrDoubleClickHandler(event, ()=>reveal(id), ()=>{reveal(id);edit(id)})
        }

        function simpleOrDoubleClickHandler(event, toCallIfSimpleClick, toCallIfDoubleClick) {
            if (event.detail === 1) {
                timer = setTimeout(() => {
                    toCallIfSimpleClick()
                }, 200)
            } else if (event.detail === 2) {
                clearTimeout(timer)
                toCallIfDoubleClick()
            }
        }

        function edit(divId) {
            const div = document.getElementById(divId);
            if (!div) return; // Exit if div not found

            // Make the div editable
            div.contentEditable = true;

            // Focus the div
            div.focus();

            // Place the cursor at the end of the text
            const range = document.createRange();
            range.selectNodeContents(div);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            // Add event listener to handle when editing is complete
            div.addEventListener('blur', function() {
                div.contentEditable = false;

            });
        }

        function doSomething(toWrite) {
            fetch(HOST + "kanjis", {
                method: "POST",
                body: JSON.stringify({
                    message: toWrite
                }),
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
                .then((response) => response.json())
                .then((json) => console.log(json));
        }

        function setVisibleMainTab(tab) {
            var kanaTabNode = document.querySelector('.kanaTab');
            var kanjiTabNode = document.querySelector('.kanjiTab');
            var vocabularyTabNode = document.querySelector('.vocabularyTab');
            var toSetVisibleNode = document.querySelector('.' + tab);
            kanaTabNode.style.visibility = 'collapse';
            kanjiTabNode.style.visibility = 'collapse';
            vocabularyTabNode.style.visibility = 'collapse';
            toSetVisibleNode.style.visibility = 'visible';
            color = ""
            switch (tab) {
                case 'kanjiTab':
                    color = "lighten(@secondary,10%)"
                    break;
                case 'kanaTab':
                    color = "lighten(@tertiary,10%)"
                    break;
                default:
                    color = "lighten(@primary,10%)"
            }
            less.modifyVars({
                '@current-tab-color': color,
            });
        }

        async function switchWordListVisibility(goToWordList) {
            var listNode = document.querySelector('.words-list-activity');
            var testNode = document.querySelector('.word-tester-activity');
            if (goToWordList || listNode.style.display == 'none') {
                listNode.style.display = 'block'
                testNode.style.display = 'none';
                await getAllWords()
                setWordList(words)
            } else {
                listNode.style.display = 'none';
                testNode.style.display = 'grid';
            }
        }

        function setWordList(wordList) {
            let listTableNode = document.querySelector('#word-list-table');
            listTableNode.replaceChildren();
            wordList.split('\n').forEach(function (wordLine, i) {
                if (wordLine == "") return
                let splittedLine = wordLine.split('|')
                let htmlSentence = `
                <tr id="wordListIdx${i + 1}" onclick="(async () => {await getWord('${splittedLine[0].trim()}'); switchWordListVisibility(); })()">
                    <td>${splittedLine[1]}</td>
                    <td>${splittedLine[2]}</td>
                    <td>${splittedLine[3]}</td>
                    <td>${splittedLine[4]}</td>
                </tr>`
                listTableNode.insertAdjacentHTML('beforeend', htmlSentence)
            });
        }

        function startSearchingInWordList() {
            switchWordListVisibility(true)
            switchSearchBarVisibility(true, true)
        }

        function switchSearchBarVisibility(visible, focusOnIt) {
            var searchBarNode = document.getElementById('search-bar');
            let searchBarInputNode = document.getElementById('search-bar-input')
            if (visible || searchBarNode.style.display == 'none') {
                searchBarNode.style.display = 'block';
                searchBarNode.addEventListener('input', filterWords);
            } else {
                searchBarNode.removeEventListener('input', filterWords)
                filtered = words
                searchBarInputNode.value = ""
                searchBarNode.style.display = 'none';
            }
            if (focusOnIt) {
                switchTabsVisibility(false)
                searchBarInputNode.focus();
            } else {
                switchTabsVisibility(true)
            }
        }

        function switchTabsVisibility(visible) {
            let tabs = document.getElementsByClassName('tab')
            shouldBeVisible = (visible || tabs[0].style.display == 'none')
            for (let i = 0; i < tabs.length; i++) {
                if (shouldBeVisible) {
                    tabs[i].style = {}
                } else {
                    tabs[i].style.display = 'none'
                }
            }
        }

        function filterWords(event) {
            setWordList((words.split('\n').filter(w => w.includes(event.target.value))).join('\n'))
        }

        function resetObfuscation() {
            let elements = document.getElementsByClassName("card")
            Array.from(elements).forEach(e => {
                if (e.classList.contains("obfuscated")) {
                    e.classList.remove("obfuscated");
                }
            })
        }

        function reveal(id) {
            document.getElementById(id).classList.remove("obfuscated");
        }

        function switchNoKanjiMode(value) {
            currentWord.useReading = value??(currentWord.useReading=="0" ? "1" : "0")
            const isNoKanji = currentWord.useReading == "0" ? false : true
            document.getElementById("no-kanji-checkbox").checked = isNoKanji
            document.getElementById('word').innerText = isNoKanji ? currentWord.reading : currentWord.word
            document.getElementById("no-kanji-label").style.visibility = isNoKanji ? 'visible' : 'collapse'
        }
        function switchUnlockedMode(value) {
            currentWord.unlocked = value??(currentWord.unlocked=="0" ? "1" : "0")
            const unlocked = currentWord.unlocked == "0" ? false : true            
            document.getElementById("unlocked-checkbox").checked = unlocked
        }

        function showDeletionConfirmation() {
            let element1 = document.getElementById("cancel-deletion-button")
            let element2 = document.getElementById("confirm-deletion-button")
            if (element1.style.visibility == "visible") {
                element1.style.visibility = "collapse"
                element2.style.visibility = "collapse"
            } else {
                element1.style.visibility = "visible"
                element2.style.visibility = "visible"
            }
        }

    </script>

    <div class="uonihon-html-divided-in-two-main-spaces">
        <div class="uonihon-main-space top-main-space">
            <div class="uonihon-app vocabulary-app">
                <div class="word-tester-activity" >


                    <div class="line1 line"> </div>
                    <div class="line5 line thicker"> </div>
                    <div class="line3 line"> </div>
                    <div class="line4 line "> </div>

                    <div class="word obfuscation-container" onclick="reveal('word')" >
                        <div class="label">Mot <span id="no-kanji-label">(Sans Kanji)</span></div>
                        <div id='word' class="card big-font">
                        </div>
                    </div>
                    <div class="reading obfuscation-container" onclick="reveal('reading')">
                        <div class="label">Prononciation</div>
                        <div id="reading" class="card big-font"></div>
                    </div>

                    <div class="meaning obfuscation-container" onclick="reveal('meaning')">
                        <div class="label">Sens Principal</div>
                        <div id="meaning" class="card"></div>
                    </div>

                    <div class="alternative obfuscation-container" onclick="reveal('alternative')">
                        <div class="label">Autres Sens</div>
                        <div id="alternative" class="card">
                        </div>
                    </div>

                    <div class="explainer obfuscation-container" onclick="reveal('explainer')">
                        <div class="label">Explications</div>
                        <div id="explainer" class="card align-start"></div>
                    </div>

                    <div id="sentences-container" class="sentences">
                    </div>

                    <div id="sentences-Adder" class="sentenceAdd card even-padding">
                        <img src="asset/cross.png" class="icon small"></button>
                        <span class="small">Ajouter une phrase</span>
                    </div>

                    <div id="no-kanji-choice" class="noKanji card even-padding" onclick="switchNoKanjiMode()">
                        <input type="checkbox" autocomplete="off" id="no-kanji-checkbox" class="checkbox-style" onclick="switchNoKanjiMode()">
                        <span class="checkbox-label">Mode Sans-Kanji</span>
                    </div>

                    <div id="familiarity familiarity-choice" class="familiarity card even-padding">
                        Familiarité :&nbsp
                        <span id="familiarity-choice-value"></span>
                    </div>

                    <div class="moreInfo sub-footer">
                        <span id="amount-seen-info">Nombre de fois vus : <span id="amount-seen-value"></span></span>
                        <span id="date-last-seen">&nbsp&nbsp&nbspDate du dernier test : <span id="date-last-seen-value"></span></span>
                    </div>

                    <div id="unlocked-choice" class="unlocked card even-padding" onclick="switchUnlockedMode()">
                        <input type="checkbox" autocomplete="off" id="unlocked-checkbox" class="checkbox-style">
                        <span class="checkbox-label">Évaluable</span>
                    </div>

                    <div id=" delete-choice" class="delete card even-padding" onclick="showDeletionConfirmation()">
                        Supprimer
                    </div>

                    <div class="nothing"></div>

                    <div class="nothing"></div>

                    <div id="confirm-deletion-button" class="confirm card even-padding" onclick="deleteCurrentWord()" style="visibility: collapse;">
                        Confirmer
                    </div>

                    <div id="cancel-deletion-button" class="cancel card even-padding" onclick="showDeletionConfirmation()" style="visibility: collapse;">
                        Annuler
                    </div>
                </div>

                <div class="words-list-activity" style="display: none;">
                    
                    <div id="search-bar" class="wordInput no-padding primary-background" style="display: none;">
                        <input id="search-bar-input" type="search" class="word-search-input" onfocusout="switchSearchBarVisibility(false)"></input>
                    </div>

                    <table class="elegant-table"><thead>
                        <tr>
                            <th>Mot</th>
                            <th>Prononciation</th>
                            <th>Sens</th>
                            <th>Autres Sens</th>
                        </tr></thead>
                        <tbody id="word-list-table">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="uonihon-app kanji-app" style="visibility: collapse;">
                this is the kanji tab Start
                <div class="wideguy secondary-background"></div>
                this is the kanji tab End
            </div>
            <div class="uonihon-app kana-app" style="visibility: collapse;">
                this is the kana tab Start
                <div class="wideguy tertiary-background"></div>
                this is the kana tab End
            </div>
        </div>

        <div class="uonihon-main-space bottom-main-space">

            <div class="tab list inline" onclick="switchWordListVisibility()">
                <img class="icon" src="asset/list.png" alt="Vocabulary icon">
                <div class="tab-text">Liste</div>
            </div>

            <div class="tab search inline" onclick="startSearchingInWordList()">
                <img class="icon" src="asset/search.png" alt="Kanji icon">
                <div class="tab-text">Chercher</div>
            </div>

            <div class="tab add inline" onclick="setVisibleTab('produceTab')">
                <img class="icon" src="asset/cross.png" alt="Vocabulary icon">
                <div class="tab-text">Ajout</div>
            </div>

            <div class="tab reading inline" onclick="getWord(null, 'reading')">
                <img class="icon" src="asset/arrow-down.png" alt="Vocabulary icon">
                <div class="tab-text">Lire</div>
            </div>

            <div class="tab writing inline" onclick="getWord(null, 'writing')">
                <img class="icon" src="asset/arrow-up.png" alt="Kanji icon">
                <div class="tab-text">Dire</div>
            </div>

            <div class="tab vocabulary primary-background" onclick="setVisibleMainTab('vocabularyTab')">
                <img class="icon" src="asset/letterW.png" alt="Vocabulary icon">
                <div class="tab-text">Vocabulaire</div>
            </div>

            <div class="tab kanji secondary-background" onclick="setVisibleMainTab('kanjiTab')">
                <img class="icon" src="asset/complicatedKanji.png" alt="Kanji icon">
                <div class="tab-text">Kanji</div>
            </div>

            <div class="tab kana tertiary-background" onclick="setVisibleMainTab('kanaTab')">
                <img class="icon" src="asset/HiraganaKa.png" alt="Kana icon">
                <div class="tab-text">Kana</div>
            </div>
                
        </div>

    </div>

</body>

</html>